#!/usr/bin/perl

use strict;    # Включаем строгий режим для лучшей проверки ошибок.
use warnings;  # Включаем предупреждения для отладки.

print "Введите количество дисков: ";
chomp(my $n = <>);  # Считываем ввод и удаляем символ новой строки.

if ($n !~ /^\d+$/ || $n < 1 || $n > 20) {
    print "Пожалуйста, введите положительное целое число от 1 до 20.\n";
    exit;
}

# Инициализируем стержни как массивы:
# - @A: Исходный стержень с дисками от 1 (маленький) до n (большой), в обратном порядке (большие внизу).
# - @B: Вспомогательный стержень, изначально пустой.
# - @C: Целевой стержень, изначально пустой.
my @A = reverse(1..$n);  # Стержень A (исходный) с дисками в порядке от большого к маленькому сверху.
my @B = ();              # Стержень B (вспомогательный), пустой.
my @C = ();              # Стержень C (целевой), пустой.

# Открываем файл для записи выходной информации.
# Файл 'hanoi_output.txt' будет перезаписан, если существует.
open(my $fh, '>', 'hanoi_output.txt') or die "Не удалось открыть файл: $!";

# Вызываем функцию для вывода начального состояния стержней в файл.
print_state($fh);

# Вызываем рекурсивную функцию для решения задачи Ханойских башен.
# Параметры: количество дисков, исходный стержень, целевой, вспомогательный.
hanoi($n, 'A', 'C', 'B', $fh);

# Закрываем файл после завершения.
close($fh);

# Сообщаем пользователю, что результат записан в файл.
# Это единственный вывод на консоль после ввода.
print "Решение записано в файл 'hanoi_output.txt'.\n";

# Рекурсивная функция для решения задачи Ханойских башен.
# Параметры:
# - $n: Количество дисков для перемещения.
# - $from: Исходный стержень (A, B или C).
# - $to: Целевой стержень.
# - $aux: Вспомогательный стержень.
# - $fh: Файловый дескриптор для записи в файл.
# Алгоритм:
# 1. Если n == 1, просто переместить диск и вывести состояние.
# 2. Иначе: Рекурсивно переместить n-1 дисков на вспомогательный.
# 3. Переместить оставшийся диск на целевой.
# 4. Рекурсивно переместить n-1 дисков с вспомогательного на целевой.
sub hanoi {
    my ($n, $from, $to, $aux, $fh) = @_;
    
    if ($n == 1) {
        # Базовый случай: перемещаем один диск.
        move_disk($from, $to, $fh);
        # Выводим состояние после перемещения.
        print_state($fh);
        return;
    }

    # Шаг 1: Рекурсивно перемещаем n-1 дисков с исходного на вспомогательный.
    # Целевой становится вспомогательным для этой подзадачи.
    hanoi($n - 1, $from, $aux, $to, $fh);
    
    # Шаг 2: Перемещаем оставшийся (самый большой) диск на целевой стержень.
    move_disk($from, $to, $fh);
    # Выводим состояние после этого ключевого перемещения.
    print_state($fh);

    # Шаг 3: Рекурсивно перемещаем n-1 дисков со вспомогательного на целевой.
    # Исходный становится вспомогательным для этой подзадачи.
    hanoi($n - 1, $aux, $to, $from, $fh);
}

# Функция для перемещения диска между стержнями.
# Параметры:
# - $from: Стержень, с которого снимаем диск.
# - $to: Стержень, на который кладем диск.
# - $fh: Файловый дескриптор для записи.
# Логика:
# - Получаем ссылку на массив стержня $from.
# - Снимаем верхний диск с $from (pop) и кладем на $to (push).
# - Записываем сообщение о перемещении в файл.
sub move_disk {
    my ($from, $to, $fh) = @_;

    # Получаем последний диск со стержня $from и сразу удаляем его (pop).
    # Используем eval для динамического доступа к массиву по имени переменной $from.
    my $disk = eval "pop \@$from";  # Снимаем и сохраняем значение диска.
    eval "push \@$to, $disk";       # Кладем диск на целевой стержень.

    # Записываем сообщение о перемещении в файл.
    print $fh "Перенос диска диаметра $disk со стержня $from на стержень $to.\n";
}

# Функция для вывода текущего состояния стержней в файл.
# Параметры:
# - $fh: Файловый дескриптор.
# Выводит содержимое @A, @B, @C в файл с разделителями.
sub print_state {
    my ($fh) = @_;
    
    # Записываем заголовок состояния.
    print $fh "\nТекущее состояние стержней:\n";
    # Выводим стержень A.
    print $fh "Стержень A: @A\n";
    # Выводим стержень B.
    print $fh "Стержень B: @B\n";
    # Выводим стержень C.
    print $fh "Стержень C: @C\n\n";
}